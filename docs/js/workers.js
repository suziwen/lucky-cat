var Utils,_runPouchFn,buildDocFullSearchView,buildFullSearchView,buildNormalView,buildViews,createResult,fullSearch,fullSearchOpts,importScriptFilenames,isRuningMessageData,pouchdbInstance,requirejs,runPouchFn,runPouchInSequenceFn,sequenceMessageDatas,wrapFullSearchProcessInfo,xsjVersion;importScriptFilenames=["./segmentit.min.js","./pouchdb/worker/pouchdb.min.js","./pouchdb/worker/pouchdb.indexeddb.js","./pouchdb/worker/underscore.js","./pouchdb/worker/markdown-it.js","./pouchdb/worker/markdown-it-wikilink.min.js","./pouchdb/worker/async.js","./pouchdb/pouchdb.find.js","./pouchdb/pouchdb.quick-search.js","./pouchdb/lunr.zh.js"],("function"==typeof require||Intl&&Intl.Segmenter)&&importScriptFilenames.shift(),pouchdbInstance=null,xsjVersion=null,requirejs=function(e){return"./lib/utils"===e?Utils:null},(Utils={}).getLinkInfo=function(e,n){var r,t;return!1,!0,t=[],(r=markdownit({html:!0,xhtmlOut:!0,breaks:!0,langPrefix:"language-",linkify:!0,typographer:!0,_highlight:!0,_strict:!1,_view:"html",noRemoteResource:!0})).use(markdownitWikilink),r.renderer.rules.link_open=function(e,n,r,t,u){var s,i,c,a;return a=e[n],(i=e[n-1])&&"text"===i.type&&(s=(c=i.content||"").substring(c.length-1),["=","%","~"].indexOf(s)>=0&&a.attrJoin("class","attachment")),u.renderToken(e,n,r,t,u)},n=r.render(n),!0&&n.replace(/<\s*a[^>]*>(.*?)<\s*\/\s*a>/gi,(function(e,n){var r,u,s,i,c,a,o,l,h;if(n=n.replace(/<[^>]+>/g,""),c=/( href="([^"]*)")|( href='([^']*)')/i,h=/( title="([^"]*)")|( title='([^']*)')/i,u=/( class="([^"]*)")|( class='([^']*)')/i,i="",l="",r="",(a=e.match(c))&&(i=a[2]||a[4],i=decodeURI(i)),(a=e.match(h))&&(l=a[2]||a[4]),(a=e.match(u))&&(r=a[2]||a[4]),!(r&&r.indexOf("attachment")>=0||/(^data:)|(^blob:)|(^file:)|(^chrome-extension:)|(^#)/i.test(i)))return s="",(o=i.lastIndexOf("#"))>0&&(s=i.substring(o+1),i=i.substring(0,o)),i?(i=i.replace(/^[\.\/]*|\/*$/g,""),t.push({link:i,hashTag:s,title:l,text:n})):void 0})),t},buildNormalView=function(e,n,r,t){var u;return u={limit:0},r&&(u.doc_ids=[r]),e.query(n,u).then((function(){return t()})).catch((function(e){return t(e)}))},fullSearchOpts={include_docs:!1,mm:"100%",highlighting:!1,fields:["title","content","tagNames"],language:"zh",filter:function(e){return(!e.type||"markdown"===e.type)&&!e.isDeleted}},buildDocFullSearchView=function(e,n,r){var t;return t={},Object.assign(t,fullSearchOpts),t.build=!0,n&&(t.doc_ids=[n]),e.search(t).then((function(){return r()})).catch((function(e){return r(e)}))},wrapFullSearchProcessInfo=function(e,n){return Object.assign(n,{beforeUpdateView:function(){var n;return n={success:1,id:e,type:"info",returnData:{processType:"beforeUpdateView"}},self.postMessage(n)},afterUpdateView:function(){var n;return n={success:1,id:e,type:"info",returnData:{processType:"afterUpdateView"}},self.postMessage(n)},showUpdateProgressInfo:function(n,r,t,u){var s;return s={success:1,id:e,type:"info",returnData:{processType:"showUpdateProgressInfo",result:{viewSeq:n,dbSeq:r,current:t,total:u}}},self.postMessage(s)}})},buildFullSearchView=function(e,n,r){var t,u,s,i;return u=pouchdbInstance,s={},Object.assign(s,fullSearchOpts),"info"===n?(s.info=!0,void u.search(s).then((function(e){return r(null,e)})).catch(r)):(wrapFullSearchProcessInfo(e,s),i=null,"rebuild"===n&&(i=1),t=function(){return s.destroy=!1,s.build=!0,s.since=i,u.search(s).then((function(){return r()})).catch(r)},"destroy_rebuild"===n?(s.destroy=!0,i=1,u.search(s).then((function(){return t()})).catch((function(e){return t()}))):t())},fullSearch=function(e,n,r,t){var u,s;return s={},Object.assign(s,fullSearchOpts),Object.assign(s,r),s.query=n,u=pouchdbInstance,wrapFullSearchProcessInfo(e,s),u.search(s).then((function(e){return t(null,e)})).catch(t)},createResult=function(e,n){var r;return r={success:1,id:e,type:"run"},n&&(r.success=0,r.msg=n),r},buildViews=function(e,n,r){var t;return n.push(buildDocFullSearchView),t=pouchdbInstance,async.mapSeries(n,(function(n,r){return"function"==typeof n?n(t,e,r):buildNormalView(t,n,e,r)}),(function(e){return r(e)}))},runPouchFn=function(e,n){var r,t,u,s;switch(u=e.id,t=(s=e.opts).data,s.method){case"buildFullSearchView":return r=t.buildType||"build",buildFullSearchView(u,r,(function(e,r){var t;return t=createResult(u,e),e||(t.returnData={error:e,result:r}),n(t)}));case"fullSearch":return fullSearch(u,t.query,t.opts,(function(e,r){var t;return t=createResult(u,e),e||(t.returnData={error:e,result:r}),n(t)}));case"buildViews":return buildViews(t.doc_id,t.buildViewNames,(function(e){var r;return r=createResult(u,e),e||(r.returnData={error:e}),n(r)}))}},sequenceMessageDatas=[],isRuningMessageData=!1,_runPouchFn=function(){var e;if(!isRuningMessageData)return isRuningMessageData=!0,e=sequenceMessageDatas.shift(),runPouchFn(e,(function(e){if(isRuningMessageData=!1,self.postMessage(e),sequenceMessageDatas.length>0)return _runPouchFn()}))},runPouchInSequenceFn=function(e){return sequenceMessageDatas.push(e),_runPouchFn()},self.addEventListener("message",(function(e){var n,r,t;switch((n=e.data||{}).type){case"init":return t=(r=n.opts).pouchdbOpt,xsjVersion=r.xsjVersion,importScriptFilenames.map((function(e){return xsjVersion&&(e=e+"?v="+xsjVersion),self.importScripts(e)})),PouchDB.plugin(PouchQuickSearch),pouchdbInstance=new PouchDB(t.name,{adapter:t.adapter}),self.postMessage({success:1,msg:"inited",type:n.type});case"run":return runPouchInSequenceFn(n)}}));
